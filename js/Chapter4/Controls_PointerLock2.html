<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ポインターロックコントロールによるカメラ操作２</title>
<script src="../three.js_r75/build/three.js"></script>  <!-- Three.js用ライブラリ -->
<script src="../three.js_r75/examples/js/controls/PointerLockControls.js"></script> <!-- ポインターロックコントロール用ライブラリ -->
<style>
*{padding:0px; margin:0px}
div#canvas-frame{
	width: 500px;  /* 横幅 */
	height: 500px; /* 縦幅 */
	overflow:hidden;
}
</style>
<script>
////////////////////////////////////////////////////////////////////
// windowイベントの定義
////////////////////////////////////////////////////////////////////
window.addEventListener("load", function () {
	threeStart(); //Three.jsのスタート関数の実行
});
////////////////////////////////////////////////////////////////////
// Three.jsスタート関数の定義
////////////////////////////////////////////////////////////////////
function threeStart() {
	initThree();  //Three.js初期化関数の実行
	initObject(); //オブジェクト初期化関数の実行
	initCamera(); //カメラ初期化関数の実行
	loop();       //無限ループ関数の実行
}
////////////////////////////////////////////////////////////////////
// Three.js初期化関数の定義
////////////////////////////////////////////////////////////////////
//グローバル変数の宣言
var renderer,    //レンダラーオブジェクト
    scene,       //シーンオブジェクト
    canvasFrame; //キャンバスフレームのDOM要素
function initThree() {
	//キャンバスフレームDOM要素の取得
	canvasFrame = document.getElementById('canvas-frame');
	//レンダラーオブジェクトの生成
	renderer = new THREE.WebGLRenderer({ antialias: true });

	if (!renderer) alert('Three.js の初期化に失敗しました');
	//レンダラーのサイズの設定
	renderer.setSize(canvasFrame.clientWidth, canvasFrame.clientHeight);
	//キャンバスフレームDOM要素にcanvas要素を追加
	canvasFrame.appendChild(renderer.domElement);

	//レンダラークリアーカラーの設定
	renderer.setClearColor(0xEEEEEE, 1.0);

	//シーンオブジェクトの生成
	scene = new THREE.Scene();
}
////////////////////////////////////////////////////////////////////
// カメラ初期化関数の定義
////////////////////////////////////////////////////////////////////
//グローバル変数の宣言
var camera;   //カメラオブジェクト
var control; //コントロールオブジェクト
function initCamera() {
	//カメラオブジェクトの生成
	camera = new THREE.PerspectiveCamera(60, canvasFrame.clientWidth / canvasFrame.clientHeight, 1, 10000);
	//カメラの位置の設定
	camera.position.set(20, 0, 100);
	//カメラの上ベクトルの設定
	camera.up.set(0, 0, 1); //ポインタロックコントロール時は無効
	//カメラの中心位置ベクトルの設定
	camera.lookAt({ x: 0, y: 0, z: 0 }); //ポインタロックコントロール時は無効

	//ポインタロックコントロールオブジェクトの宣言
	control = new THREE.PointerLockControls( camera );
	scene.add( control.getObject() );
	//キャンバスフレーム要素をクリックしたときのイベント登録
	canvasFrame.addEventListener('click', function (event) {
		//ポインタロックを有効
		document.body.requestPointerLock();
	}, false);
	//ポインタロックイベントの追加
	document.addEventListener('pointerlockchange', pointerlockchange);
	//ポインタロックの変更時に呼び出される関数
	function pointerlockchange(event) {
		if (document.pointerLockElement === document.body ) {
			//ポインタロックコントロールを有効化
			control.enabled = true;
		} else {
			//ポインタロックコントロールを無効化
			control.enabled = false;
		}
	}

	//各種フラグ
	control.moveForward = false;  //前進
	control.moveBackward = false; //後進
	control.moveLeft = false;     //左進
	control.moveRight = false;    //右進
	control.canJump = false;      //ジャンプ可能
	//速度ベクトル
	control.velocity = new THREE.Vector3();

	//キーダウンイベント
	document.addEventListener( 'keydown', function ( event ) {
		//キーの種類の判定
		switch ( event.keyCode ) {
			case 38: // 「↑」
			case 87: // 「w」
				control.moveForward = true; break;
			case 37: // 「←」
			case 65: // 「a」
				control.moveLeft = true; break;
			case 40: // 「↓」
			case 83: // 「s」
				control.moveBackward = true; break;
			case 39: // 「→」
			case 68: // 「d」
				control.moveRight = true; break;
			case 32: // スペース
				if ( control.canJump === true ) control.velocity.y += 300;
				control.canJump = false;
				break;

		}
	}, false );

	//キーアップイベント
	document.addEventListener( 'keyup', function ( event ) {
		//キーの種類の判定
		switch( event.keyCode ) {
			case 38: // 「↑」
			case 87: // 「w」
				control.moveForward = false; break;
			case 37: // 「←」
			case 65: // 「a」
				control.moveLeft = false; break;
			case 40: // 「↓」
			case 83: // 「s」
				control.moveBackward = false; break;
			case 39: // 「→」
			case 68: // 「d」
				control.moveRight = false; break;
		}
	}, false );
}

////////////////////////////////////////////////////////////////////
// オブジェクト初期化関数の定義
////////////////////////////////////////////////////////////////////
//グローバル変数の宣言
var axis; //軸オブジェクト
var cubes = []; //直方体オブジェクト
function initObject() {
	//軸オブジェクトの生成
	axis = new THREE.AxisHelper(100);
	//軸オブジェクトのシーンへの追加
	scene.add(axis);
	//軸オブジェクトの位置座標を設定
	axis.position.set(0, 0, 0);

	///////////////直方体の形状と材質の定義//////////////////
	//形状オブジェクトの宣言と生成
	var geometry = new THREE.CubeGeometry(30, 30, 30);
	//材質オブジェクトの宣言と生成
	var material = new THREE.MeshNormalMaterial();

	///////////////直方体オブジェクトの準備//////////////////
	//直方体オブジェクトの生成
	cubes[0] = new THREE.Mesh(geometry, material);
	//直方体オブジェクトのシーンへの追加
	scene.add(cubes[0]);
	//直方体オブジェクトの位置座標を設定
	cubes[0].position.set(0, -50, 0);

	//直方体オブジェクトの生成
	cubes[1] = new THREE.Mesh(geometry, material);
	//直方体オブジェクトのシーンへの追加
	scene.add(cubes[1]);
	//直方体オブジェクトの位置座標を設定
	cubes[1].position.set(0, 0, 0);

	//直方体オブジェクトの生成
	cubes[2] = new THREE.Mesh(geometry, material);
	//直方体オブジェクトのシーンへの追加
	scene.add(cubes[2]);
	//直方体オブジェクトの位置座標を設定
	cubes[2].position.set(0, 50, 0);

}

////////////////////////////////////////////////////////////////////
// 無限ループ関数の定義
////////////////////////////////////////////////////////////////////
//グローバル変数の宣言
var step = 0; //ステップ数
var lastTime = new Date();  //基準時刻オブジェクト
function loop() {
	//ステップ数のインクリメント
	step++;
	//各直方体の角度の変更
	cubes[0].rotation.set(step / 100, 0, 0);
	cubes[1].rotation.set(0, step / 100, 0);
	cubes[2].rotation.set(0, 0, step / 100);

	//ポインタロックコントロールが有効の場合
	if ( control.enabled ) {
		//現在時刻オブジェクトの取得
		var nowTime = new Date();
		//１フレームあたりの経過時間
		var delta = (nowTime - lastTime) / 1000; 
		//基準時刻オブジェクトの更新
		lastTime = nowTime;

		//減速
		control.velocity.x -=  control.velocity.x * 10.0 * delta;
		control.velocity.z -=  control.velocity.z * 10.0 * delta;
		control.velocity.y -= 9.8 * 100 * delta; 

		//カメラの移動速度の更新
		if ( control.moveForward )  control.velocity.z -= 400.0 * delta;
		if ( control.moveBackward )  control.velocity.z += 400.0 * delta;
		if ( control.moveLeft )  control.velocity.x -= 400.0 * delta;
		if ( control.moveRight )  control.velocity.x += 400.0 * delta;

		//カメラの位置座標の更新
		control.getObject().translateX( control.velocity.x * delta );
		control.getObject().translateY( control.velocity.y * delta );
		control.getObject().translateZ( control.velocity.z * delta );

		//yの最小値の判定
		if ( control.getObject().position.y < 10 ) {

			//速度0、位置10に固定
			control.velocity.y = 0;
			control.getObject().position.y = 10;
			//ジャンプ可能フラグを設定
			control.canJump = true;
		}
	}

	//レンダリング
	renderer.render(scene, camera);

	//画像生成
	makePicture();

	//「loop()」関数の呼び出し
	requestAnimationFrame(loop);

}

//////////////////////////////////////////////
// 画像作成用	
//////////////////////////////////////////////
var makePictureFlag = false;

//画像作成用イベント
window.addEventListener('keydown', function (e) {

	//キーボードイベント時のキー取得
	var keyChar = String.fromCharCode( e.keyCode ).toLowerCase();

	//キーボードの「s」が押された場合
	if(keyChar == "s") {
		makePictureFlag = true;
	}

});	
//画像作成関数
function makePicture(){

	if( !makePictureFlag ) return;

	//グラフィックスが描画されたcanvas要素
	var canvas = renderer.domElement;

	//a要素の生成
	var a = document.createElement("a");
	//canvas要素→DataURL形式
	a.href = canvas.toDataURL("image/png");
	//PNGファイル名の命名
	a.download = "picture";
	a.innerHTML = "ダウンロード";

	//id="thumbnails"のdiv要素の子要素にa要素を追加	
	document.getElementsByTagName( "body" )[0].appendChild(a);

	makePictureFlag = false;

}
</script>
</head>
<body>
	<div id="canvas-frame"></div><!-- canvas要素を配置するdiv要素 -->
</body>
</html>